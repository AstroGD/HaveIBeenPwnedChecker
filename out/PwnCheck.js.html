<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: PwnCheck.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: PwnCheck.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>//Node Native Modules
const eventEmitter = require("events");
const crypto = require("crypto");

//NPM hosted Modules
const https = require('follow-redirects').https;

/**
 * This class represents a Password that is getting checked by HIBP
 * 
 * @extends EventEmitter
 * 
 * @property {boolean} ready                    - Indicates whether the password has been hashed and is ready to be checked
 * @property {string} hash                      - The hashed password. Available after the ready event
 * @property {string} identifier                - The first five characters of the hash. This will be sent to HIBP
 * @property {object} requestOptions            - Options for the request that querys the HIBP database
 * @property {string} requestOptions.method             - HTTP method that will be used for the request
 * @property {string} requestOptions.hostname           - Hostname that will be requested (example.org NOT example.org/bla/blablubb)
 * @property {string} requestOptions.path               - Path on the host that will be requested (/bla/blablubb NOT example.org/bla/blablubb or example.org)
 * @property {number} requestOptions.maxRedirects       - Max redirects allowed before the request fails and throws an error
 * @property {string} rawResponse               - The raw data that was sent from the api
 * @property {boolean} breached                 - Indicates whether the password was breached and therefore found in the database of HIBP
 * @property {number} howOftenBreached          - number of incidents that diclosed the password
 */
class Password extends eventEmitter {
    /**
     * @param {string} password                 - The Password that will be checked against HIBP
     */
    constructor(password) {
        super();

        //Will be true after the init function finished
        this.ready = false;

        this.init(password.toString());
    }

    /**
     * Hashes the password and then fires the ready event
     * 
     * @param {string} password                 - The password that will be checked against HIBP
     * @fires Password#ready                    - Fires after the password has been hashed and is ready to be checked
     * @returns {Promise&lt;void>}
     */
    async init(password) {
        const hash = crypto.createHash('sha1');

        const hashedPassword = await new Promise((resolve, _reject) => {
            hash.on('readable', () => {
                const data = hash.read();
                if (data) {
                    resolve(data.toString('hex'));
                }
            });

            hash.write(password);
            hash.end();
        });

        this.hash = hashedPassword;
        this.identifier = hashedPassword.substring(0, 5);
        this.ready = true;

        /**
         * Emitted when the password has been hashed and the class is ready to check for breaches on HIBP
         * 
         * @event Password#ready
         */
        this.emit("ready");
    }

    /**
     * Checks the Password for being present in the HIBP Database
     * 
     * @returns {Promise&lt;boolean>}              - Returns a boolean indicating whether the password has been breached or not
     * @example
     * Password.check()
     *   .then(breached => {
     *     if (breached) {
     *       console.log("Oh no my password has been breached I should change it immediately!");
     *     } else {
     *       console.log("All good nothing to worry here :) ");
     *     }
     *   })
     *   .catch(e => {
     *     //Oh no I guess something went wrong here :(
     *     console.error(e);
     *   });
     */
    async check() {
        if (!this.ready) throw new Error("The Password has not been hashed yet");

        let requestOptions = {
            'method': 'GET',
            'hostname': 'api.pwnedpasswords.com',
            'path': `/range/${this.identifier.toString()}`,
            'maxRedirects': 20
        };
        this.requestOptions = requestOptions;

        let response;
        try {
            response = await new Promise((resolve, reject) => {
                const req = https.request(requestOptions, function (res) {
                    var chunks = [];

                    res.on("data", function (chunk) {
                        chunks.push(chunk);
                    });

                    res.on("end", function () {
                        var body = Buffer.concat(chunks);
                        resolve(body.toString());
                    });

                    res.on("error", function (error) {
                        reject(error);
                    });
                });

                req.end();
            });
        } catch (error) {
            throw error;
        }

        this.rawResponse = response;

        let responseArr = response.split("\n");
        let subHash = this.hash.substring(5, Infinity);
        let breached = false;
        let howOftenBreached = 0;

        responseArr.forEach((savedBreach) => {
            let hash = savedBreach.split(":")[0];
            if (hash.toLowerCase() == subHash.toLowerCase()) {
                breached = true;
                howOftenBreached = Number(savedBreach.split(":")[1]);
            }
        });

        this.breached = breached;
        this.howOftenBreached = howOftenBreached;

        /**
         * Emitted whenever the password was checked for appearing in the databse of HIBP
         * 
         * @event Password#checked
         * @param {boolean} breached            - Indicates whether the Password has been breached or not
         */
        this.emit("checked", breached);

        if (breached) {
            /**
             * Emitted whenever the password was checked and found in the database of HIBP
             * 
             * @event Password#breached
             * @param {number} howOftenBreached - The number of incidents that disclosed the password
             */
            this.emit("breached", howOftenBreached);
        }

        return breached;
    }
}

module.exports = {
    Password
};</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Password.html">Password</a></li></ul><h3>Events</h3><ul><li><a href="Password.html#event:breached">breached</a></li><li><a href="Password.html#event:checked">checked</a></li><li><a href="Password.html#event:ready">ready</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Sat Mar 07 2020 00:27:44 GMT+0100 (GMT+01:00)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
